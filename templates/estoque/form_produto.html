{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/estoque/dashboard_estoque.css') }}">
<style>
    .form-container { max-width: 950px; margin: 20px auto; background: var(--menu-bg-light); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--card-shadow-light); }
    .dark-theme .form-container { background: var(--menu-bg-dark); box-shadow: var(--card-shadow-dark); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 30px; }
    .form-group { margin-bottom: 15px; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light-contrast); }
    .dark-theme .form-group label { color: var(--text-dark); }
    .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: var(--border-radius-sm); border: 1px solid var(--menu-border-light); background: var(--bg-light); color: var(--text-light); box-sizing: border-box; }
    .dark-theme .form-group input, .dark-theme .form-group textarea { border-color: var(--menu-border-dark); background: var(--bg-dark); color: var(--text-dark); }
    .form-actions { grid-column: 1 / -1; display: flex; justify-content: flex-start; gap: 15px; margin-top: 20px; }
    .btn { padding: 12px 25px; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(45deg, var(--accent-light), #ff7e5f); color: white; }
    .btn-secondary { background-color: #e0e0e0; color: #333; }
    .dark-theme .btn-secondary { background-color: #444; color: #eee; }
    .ai-header { grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--menu-border-light); padding-top: 20px; margin-top: 10px; }
    .dark-theme .ai-header { border-top-color: var(--menu-border-dark); }
    .ai-sugestao-btn { padding: 5px 10px; font-size: 0.8rem; background: transparent; color: var(--primary-bright); border: 1px solid var(--primary-bright); border-radius: 20px; cursor: pointer; }
    .dark-theme .ai-sugestao-btn { color: var(--primary-dark); border-color: var(--primary-dark); }
    #ai-justificativa { grid-column: 1 / -1; margin-top: 10px; padding: 15px; border-radius: var(--border-radius-sm); background: rgba(0, 208, 255, 0.1); border-left: 4px solid var(--primary-bright); font-size: 0.9rem; display: none; }
    .dark-theme #ai-justificativa { background: rgba(0, 240, 255, 0.1); border-left-color: var(--primary-dark); }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h1 class="dashboard-title" style="margin-bottom: 30px;">{{ titulo }}</h1>

    <form action="{{ url_for('estoque.salvar_produto') }}" method="post">
        <input type="hidden" name="id" value="{{ produto.id if produto else '' }}">

        <div class="form-grid">
            <div class="form-group">
                <label for="nome">Nome do Produto</label>
                <input type="text" id="nome" name="nome" value="{{ produto.nome if produto else '' }}" required>
            </div>
            <div class="form-group">
                <label for="sku">SKU (Código)</label>
                <input type="text" id="sku" name="sku" value="{{ produto.sku if produto else '' }}" required>
            </div>
            <div class="form-group">
                <label for="custo_unitario">Custo Unitário (R$)</label>
                <input type="number" step="0.01" id="custo_unitario" name="custo_unitario" value="{{ produto.custo_unitario if produto else '' }}">
            </div>
            <div class="form-group">
                <label for="lead_time_dias">Lead Time (dias)</label>
                <input type="number" id="lead_time_dias" name="lead_time_dias" value="{{ produto.lead_time_dias if produto else '' }}">
            </div>
            <div class="form-group full-width">
                <label for="descricao">Descrição</label>
                <textarea id="descricao" name="descricao" rows="3">{{ produto.descricao if produto else '' }}</textarea>
            </div>

            <div class="ai-header">
                <h2 class="chart-title" style="margin: 0; font-size: 1.2rem;">Parâmetros de Estoque</h2>
                {% if produto and produto.id %}
                <button type="button" id="btn-sugerir-ia" class="ai-sugestao-btn">
                    <i class="ri-robot-line"></i> Sugerir com IA
                </button>
                {% endif %}
            </div>

            <div id="ai-justificativa" class="full-width"></div>

            <div class="form-group">
                <label for="ponto_reposicao">Ponto de Reposição</label>
                <input type="number" id="ponto_reposicao" name="ponto_reposicao" value="{{ produto.ponto_reposicao if produto else '' }}">
            </div>
            <div class="form-group">
                <label for="estoque_seguranca">Estoque de Segurança</label>
                <input type="number" id="estoque_seguranca" name="estoque_seguranca" value="{{ produto.estoque_seguranca if produto else '' }}">
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Salvar</button>
                <a href="{{ url_for('estoque.listar_produtos') }}" class="btn btn-secondary">Cancelar</a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnSugerir = document.getElementById('btn-sugerir-ia');
    if (btnSugerir) {
        btnSugerir.addEventListener('click', function() {
            const produtoId = document.querySelector('input[name="id"]').value;
            if (!produtoId) return;

            const justificativaDiv = document.getElementById('ai-justificativa');
            justificativaDiv.style.display = 'block';
            justificativaDiv.textContent = 'Analisando histórico de vendas...';
            this.disabled = true;
            this.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> Processando...';

            fetch(`/estoque/api/sugerir_parametros/${produtoId}`)
                .then(response => {
                    if (!response.ok) { return response.json().then(err => { throw new Error(err.error) }); }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('ponto_reposicao').value = data.ponto_reposicao_sugerido;
                    document.getElementById('estoque_seguranca').value = data.estoque_seguranca_sugerido;
                    justificativaDiv.textContent = data.justificativa;
                })
                .catch(error => {
                    justificativaDiv.style.borderColor = 'var(--error-color)';
                    justificativaDiv.textContent = `Erro: ${error.message}`;
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="ri-robot-line"></i> Sugerir com IA';
                });
        });
    }
});
</script>
{% endblock %}
