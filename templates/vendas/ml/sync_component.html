<!-- sync_component.html -->
<div class="sync-component card">
    <div class="card-header">
        <h3>
            <i class="ri-refresh-line"></i>
            Sincronização Mercado Livre
        </h3>
        <div class="sync-actions">
            <button id="btn-sync-now" class="btn primary">
                <i class="ri-play-circle-line"></i>
                Sincronizar Agora
            </button>
            <button id="btn-sync-status" class="btn outline">
                <i class="ri-information-line"></i>
                Status
            </button>
        </div>
    </div>

    <div class="card-body">
        <!-- Status Atual -->
        <div class="sync-status-grid">
            <div class="status-item">
                <div class="status-label">Última Sincronização</div>
                <div class="status-value" id="last-sync-time">—</div>
            </div>
            <div class="status-item">
                <div class="status-label">Status</div>
                <div class="status-badge" id="sync-status-badge">
                    <span class="badge idle">OCIOSO</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">Contas Ativas</div>
                <div class="status-value" id="active-accounts">—</div>
            </div>
            <div class="status-item">
                <div class="status-label">Próxima Sinc.</div>
                <div class="status-value" id="next-sync">—</div>
            </div>
        </div>

        <!-- Progresso Atual -->
        <div id="sync-progress" class="sync-progress" style="display: none;">
            <div class="progress-header">
                <span id="progress-operation">Sincronizando...</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Estatísticas da Última Sincronização -->
        <div id="last-stats" class="sync-stats" style="display: none;">
            <h4>Última Sincronização</h4>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-new-orders">0</div>
                    <div class="stat-label">Novos Pedidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-updated-orders">0</div>
                    <div class="stat-label">Pedidos Atualizados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-total-orders">0</div>
                    <div class="stat-label">Total Processado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-duration">0s</div>
                    <div class="stat-label">Duração</div>
                </div>
            </div>
        </div>

        <!-- Configurações Rápidas -->
        <div class="sync-settings">
            <h4>Configurações de Sincronização</h4>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="sync-days-back">Dias para Buscar:</label>
                    <select id="sync-days-back">
                        <option value="7">7 dias</option>
                        <option value="30" selected>30 dias</option>
                        <option value="60">60 dias</option>
                        <option value="90">90 dias</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="sync-force-refresh">
                        Forçar atualização completa
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sync-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-item {
    background: var(--ml-dark);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--ml-border);
}

.status-label {
    font-size: 0.8rem;
    color: var(--ml-muted);
    margin-bottom: 0.5rem;
}

.status-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--ml-light);
}

.badge {
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
}

.badge.idle {
    background: var(--ml-muted);
    color: var(--ml-dark);
}

.badge.syncing {
    background: var(--ml-amarelo);
    color: var(--ml-dark);
}

.badge.success {
    background: var(--ml-success);
    color: white;
}

.badge.error {
    background: var(--ml-error);
    color: white;
}

.sync-progress {
    margin: 1.5rem 0;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.progress-bar {
    height: 8px;
    background: var(--ml-dark);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--ml-celeste), var(--ml-amarelo));
    transition: width 0.3s ease;
    border-radius: 4px;
}

.sync-stats {
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--ml-dark);
    border-radius: 8px;
    border: 1px solid var(--ml-border);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.stat-card {
    text-align: center;
    padding: 1rem;
    background: rgba(0, 191, 255, 0.1);
    border-radius: 8px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--ml-celeste);
}

.stat-label {
    font-size: 0.8rem;
    color: var(--ml-muted);
    margin-top: 0.5rem;
}

.sync-settings {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--ml-border);
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.setting-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.setting-item label {
    font-size: 0.9rem;
    color: var(--ml-light);
}

.setting-item select,
.setting-item input[type="checkbox"] {
    padding: 0.5rem;
    border: 1px solid var(--ml-border);
    border-radius: 6px;
    background: var(--ml-card);
    color: var(--ml-light);
}
</style>

<script>
class MLSyncComponent {
    constructor() {
        this.pollingInterval = null;
        this.isSyncing = false;
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadStatus();
        this.startPolling();
    }

    bindEvents() {
        // Sincronização manual
        document.getElementById('btn-sync-now')?.addEventListener('click', () => {
            this.syncNow();
        });

        // Botão de status
        document.getElementById('btn-sync-status')?.addEventListener('click', () => {
            this.loadStatus(true);
        });
    }

    async loadStatus(force = false) {
        try {
            const response = await fetch('/vendas/ml/api/sync/status');
            const data = await response.json();

            this.updateUI(data);
        } catch (error) {
            console.error('Erro ao carregar status:', error);
            this.showError('Falha ao carregar status');
        }
    }

    updateUI(data) {
        const { service_status, sync_status } = data;

        // Status básico
        document.getElementById('last-sync-time').textContent =
            sync_status.last_sync ? new Date(sync_status.last_sync).toLocaleString() : '—';

        document.getElementById('active-accounts').textContent =
            `${service_status.total_accounts} contas`;

        // Status badge
        const statusBadge = document.getElementById('sync-status-badge');
        if (sync_status.is_syncing) {
            statusBadge.innerHTML = '<span class="badge syncing">SINCRONIZANDO</span>';
            this.showProgress(sync_status.current_operation);
        } else {
            statusBadge.innerHTML = '<span class="badge idle">OCIOSO</span>';
            this.hideProgress();
        }

        // Estatísticas da última sincronização
        if (sync_status.last_stats) {
            this.showLastStats(sync_status.last_stats);
        }
    }

    showProgress(operation) {
        const progressEl = document.getElementById('sync-progress');
        const operationEl = document.getElementById('progress-operation');

        progressEl.style.display = 'block';
        operationEl.textContent = operation || 'Sincronizando...';
        this.isSyncing = true;
    }

    hideProgress() {
        document.getElementById('sync-progress').style.display = 'none';
        this.isSyncing = false;
    }

    showLastStats(stats) {
        const statsEl = document.getElementById('last-stats');
        statsEl.style.display = 'block';

        document.getElementById('stat-new-orders').textContent = stats.total_new_orders;
        document.getElementById('stat-updated-orders').textContent = stats.total_updated_orders;
        document.getElementById('stat-total-orders').textContent =
            stats.total_new_orders + stats.total_updated_orders;
        document.getElementById('stat-duration').textContent =
            `${Math.round(stats.duration)}s`;
    }

    async syncNow() {
        if (this.isSyncing) {
            alert('Sincronização já em andamento!');
            return;
        }

        const daysBack = document.getElementById('sync-days-back').value;
        const forceRefresh = document.getElementById('sync-force-refresh').checked;

        try {
            const response = await fetch('/vendas/ml/api/sync/now', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    days_back: parseInt(daysBack),
                    force_refresh: forceRefresh
                })
            });

            const result = await response.json();

            if (response.ok) {
                this.showSuccess('Sincronização iniciada!');
                this.loadStatus(true);
            } else {
                this.showError(result.error || 'Erro ao iniciar sincronização');
            }
        } catch (error) {
            console.error('Erro na sincronização:', error);
            this.showError('Falha na sincronização');
        }
    }

    startPolling() {
        // Atualiza status a cada 10 segundos quando sincronizando
        this.pollingInterval = setInterval(() => {
            if (this.isSyncing) {
                this.loadStatus();
            }
        }, 10000);
    }

    showSuccess(message) {
        // Usar sistema de notificação existente ou fallback
        if (typeof showNotification === 'function') {
            showNotification(message, 'success');
        } else {
            alert(`✅ ${message}`);
        }
    }

    showError(message) {
        if (typeof showNotification === 'function') {
            showNotification(message, 'error');
        } else {
            alert(`❌ ${message}`);
        }
    }

    destroy() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
        }
    }
}

// Inicialização quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', () => {
    window.mlSyncComponent = new MLSyncComponent();
});
</script>